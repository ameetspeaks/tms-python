name: Deploy to HuggingFace Space

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Validate environment variables
        run: |
          if [ -z "${{ vars.HF_USERNAME }}" ]; then
            echo "âŒ HF_USERNAME is not set"
            exit 1
          fi
          if [ -z "${{ vars.SPACE_NAME }}" ]; then
            echo "âŒ SPACE_NAME is not set"
            exit 1
          fi
          if [ -z "${{ secrets.HF_TOKEN }}" ]; then
            echo "âŒ HF_TOKEN is not set"
            exit 1
          fi
          echo "âœ… All required variables are set"
      - name: Setup Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git config --global credential.helper store
      - name: Configure HuggingFace credentials
        run: |
          echo "https://${{ vars.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co" > ~/.git-credentials
      - name: Add HuggingFace remote
        run: |
          HF_REPO="https://huggingface.co/spaces/${{ vars.HF_USERNAME }}/${{ vars.SPACE_NAME }}"
          echo "ðŸ”— HuggingFace Space: $HF_REPO"
          
          # Remove existing remote if it exists
          git remote remove huggingface 2>/dev/null || true
          
          # Add HuggingFace remote
          git remote add huggingface $HF_REPO
          git remote -v
      - name: Push to HuggingFace Space
        run: |
          echo "ðŸš€ Pushing to HuggingFace Space..."
          
          # Get current branch
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "ðŸ“ Current branch: $BRANCH"
          
          # Push to main branch on HuggingFace
          git push --force huggingface $BRANCH:main
          
          echo "âœ… Successfully pushed to HuggingFace Space"
      - name: Wait for Space to build
        run: |
          echo "â³ Waiting for Space to build (30 seconds)..."
          sleep 30
      - name: Health check
        run: |
          SPACE_URL="https://${{ vars.HF_USERNAME }}-${{ vars.SPACE_NAME }}.hf.space"
          echo "ðŸ” Checking Space health: $SPACE_URL/health"
          
          # Wait up to 2 minutes for the space to be ready
          for i in {1..12}; do
            if curl -f -s "$SPACE_URL/health" > /dev/null; then
              echo "âœ… Space is healthy and running!"
              echo "ðŸŒ Visit: $SPACE_URL"
              echo "ðŸ“š API Docs: $SPACE_URL/docs"
              exit 0
            fi
            echo "â³ Attempt $i/12: Space not ready yet, waiting..."
            sleep 10
          done
          
          echo "âš ï¸ Space health check timed out, but deployment may still be in progress"
          echo "ðŸŒ Check manually: $SPACE_URL"
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Space URL**: https://${{ vars.HF_USERNAME }}-${{ vars.SPACE_NAME }}.hf.space" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs**: https://${{ vars.HF_USERNAME }}-${{ vars.SPACE_NAME }}.hf.space/docs" >> $GITHUB_STEP_SUMMARY
          echo "- **Space Dashboard**: https://huggingface.co/spaces/${{ vars.HF_USERNAME }}/${{ vars.SPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
